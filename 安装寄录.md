# 疲劳检测系统 - Ubuntu 20.04版本

基于YOLO11和Dlib实现的实时疲劳检测系统，支持眼部疲劳和打哈欠检测。

## 项目特性

**实时检测**: 基于摄像头的实时疲劳状态监测
**眼部检测**: 使用EAR（眼部纵横比）算法检测眼部疲劳
**哈欠检测**: 使用MAR（嘴部纵横比）算法检测打哈欠
**AI增强**: 集成YOLO11进行面部特征智能识别
**双模式**: 支持GUI界面和命令行模式
**Ubuntu兼容**: 专门适配Ubuntu 20.04系统

## 系统要求

- Ubuntu 20.04 LTS
- Python 3.8+
- 摄像头设备
- 至少4GB内存
- （可选）NVIDIA GPU用于加速推理

## 安装说明

### 1. 创建并激活conda环境

```bash
# 如果还没有dsleep环境，创建一个
conda create -n dsleep python=3.9 -y
conda activate dsleep
```

### 2. 自动安装（推荐）

```bash
cd /home/ubuntu/NGW/intern/dsleep
chmod +x setup.sh
./setup.sh
```

### 3. 手动安装

```bash
# 安装系统依赖
sudo apt-get update
sudo apt-get install -y build-essential cmake pkg-config libgtk-3-dev

# 使用conda安装主要依赖
conda install -y -c conda-forge numpy=1.24.* scipy opencv dlib pandas matplotlib

# 安装PyTorch
conda install -y pytorch torchvision torchaudio -c pytorch

# 安装其他依赖
pip install PySide2 imutils timm einops
```

### 4. 验证安装

```bash
python test_system.py
```

## 使用方法

### 快速启动

```bash
# 激活环境
conda activate dsleep

# 进入项目目录
cd /home/ubuntu/NGW/intern/dsleep

# 一键启动（自动选择最适合的模式）
./run.sh
```



### 详细启动选项

```bash
# GUI模式（需要图形界面）
./run.sh --gui
# 或
python main.py

# 命令行模式（适合SSH或无图形界面）
./run.sh --console
# 或
python main.py --console

# 仅运行测试
./run.sh --test
# 或
python test_system.py

# 跳过测试直接启动
./run.sh --skip-test
```

### 首次运行前的准备

1. **设置系统权限**：
```bash
./setup_ubuntu_permissions.sh
```

2. **测试摄像头**：
```bash
python test_camera_ubuntu.py
```

3. **完整系统测试**：
```bash
python test_system.py
```

## 检测原理

### 疲劳检测算法

1. **EAR (Eye Aspect Ratio)**: 眼部纵横比算法
   - 正常状态: EAR > 0.3
   - 疲劳状态: EAR ≤ 0.27
   - 重度疲劳: EAR ≤ 0.25

2. **MAR (Mouth Aspect Ratio)**: 嘴部纵横比算法
   - 正常状态: MAR < 0.6
   - 打哈欠: MAR ≥ 0.6

3. **YOLO11检测**: 面部特征分类
   - 眼睛开合状态
   - 打哈欠状态

### 疲劳判定标准

- 连续眨眼次数过多
- EAR值持续过低
- 频繁打哈欠（60秒内≥3次）

## 项目结构

```
dsleep/
├── main.py                                     # 主程序入口
├── fatigue_detector.py                         # 疲劳检测模块
├── yolo_detector.py                            # YOLO检测模块
├── frame_processor.py                          # 帧处理模块
├── requirements.txt                            # 依赖列表
├── 安装寄录.md                                  # 项目说明
├── weights/                                    # 模型文件目录
│   ├── best.pt                                 # YOLO模型权重
│   └── shape_predictor_68_face_landmarks.dat   # Dlib面部关键点模型
└── config/                                     # 配置文件（预留）
```

## 配置参数

主要检测参数可在`main.py`中调整：

```python
# 眼部检测参数
EYE_THRESH = 0.3              # 眨眼阈值
CLOSED_EYE_THRESH = 0.27      # 疲劳判定阈值
MIN_BLINK_FRAMES = 2          # 最少闭眼帧数
MAX_BLINK_FRAMES = 7          # 最大闭眼帧数

# 哈欠检测参数
MOUTH_THRESH = 0.6            # 哈欠阈值
MIN_YAWN_FRAMES = 15          # 最少哈欠帧数
YAWN_INTERVAL = 60            # 哈欠检测时间窗口（秒）
MAX_YAWN_COUNT = 3            # 时间窗口内哈欠次数阈值
```

## 故障排除

### 1. 摄像头无法打开

```bash
# 检查摄像头设备
ls /dev/video*

# 测试摄像头
python -c "import cv2; cap = cv2.VideoCapture(0); print('Camera OK' if cap.isOpened() else 'Camera Error')"
```

### 2. GUI无法启动

```bash
# 检查显示环境
echo $DISPLAY

# 如果是SSH连接，启用X11转发
ssh -X username@hostname
```

### 3. 模型文件缺失

- `weights/best.pt` (YOLO模型)
- `weights/shape_predictor_68_face_landmarks.dat` (Dlib模型)

### 4. 依赖冲突

```bash
# 重新创建环境
conda deactivate
conda remove -n dsleep --all
conda create -n dsleep python=3.9 -y
conda activate dsleep
./setup.sh
```

